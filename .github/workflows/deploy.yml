name: AWS EC2 Python Deploy

on:
  push:
    branches: [ main ]  # main 브랜치에 코드가 올라오면 실행

jobs:
  # [1단계] 테스트 및 빌드 과정
  Build-and-Test:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: 파이썬 설정
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 라이브러리 설치 및 테스트
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # pytest  # 테스트 코드가 있다면 주석을 풀고 실행하세요

  # [2단계] 실제 AWS 서버 배포 과정
  Deploy:
    needs: Build-and-Test  # 1단계가 성공해야만 실행됨
    runs-on: ubuntu-latest
    steps:
      - name: AWS 서버 접속 및 업데이트
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}      # EC2의 퍼블릭 IP
          username: ubuntu                    # 보통 ubuntu 또는 ec2-user
          key: ${{ secrets.AWS_SSH_KEY }}     # .pem 키 파일의 내용
          port: 22
          script: |
            cd /home/ubuntu/project-folder     # 프로젝트 폴더로 이동
            git pull origin main               # 최신 코드 가져오기
            source venv/bin/activate           # 가상환경 활성화 (있는 경우)
            pip install -r requirements.txt    # 패키지 업데이트
            sudo systemctl restart my_app      # 프로그램 재실행 (Gunicorn/Uvicorn 등)
